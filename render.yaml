# Render Blueprint - MediAssist AI
# https://render.com/docs/blueprint-spec
#
# 배포 전 필수 설정 (Render Dashboard에서 수동 설정 필요):
# 1. MongoDB Atlas 계정 생성 후 MONGODB_URI 설정
# 2. OpenAI API Key 획득 후 OPENAI_API_KEY 설정
# 3. (선택) Neo4j Aura 계정 생성 후 NEO4J_* 설정
# 4. (선택) Cloudflare R2 또는 AWS S3 설정 후 MINIO_* 설정
#
# 예상 비용 (월):
# - PostgreSQL free: $0 (90일 후 만료)
# - Analysis Service Standard: $25 (ML 모델용)
# - 기타 서비스 Free: $0
# - 총: 약 $25/월 (유료 DB 사용 시 추가)
# 참고: Redis는 Dashboard에서 수동 생성 필요

databases:
  # PostgreSQL Database
  - name: mediassist-db
    databaseName: mediassist
    user: mediassist
    plan: free  # 무료: free (90일), 유료: basic-256mb ($7/mo), basic-1gb ($20/mo)
    region: singapore  # 또는 oregon, frankfurt 등

services:
  # ============================================
  # Frontend (React + Nginx)
  # ============================================
  - type: web
    name: mediassist-frontend
    runtime: docker
    dockerfilePath: ./frontend/Dockerfile.render
    dockerContext: ./frontend
    region: singapore
    plan: free  # 무료 가능
    buildFilter:
      paths:
        - frontend/**
    # Docker build arguments - Render에서 빌드 시 ARG로 주입됨
    envVars:
      - key: VITE_API_URL
        value: https://mediassist-analysis-4clk.onrender.com
    healthCheckPath: /health
    autoDeploy: true

  # ============================================
  # Analysis Service (Main ML Backend)
  # ============================================
  - type: web
    name: mediassist-analysis
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    region: singapore
    plan: standard  # ML 모델용 메모리 필요 (최소 standard $25/mo)
    healthCheckPath: /health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mediassist-db
          property: connectionString
      - key: REDIS_URL
        sync: false  # Redis 수동 설정 필요 (Dashboard에서 Key-Value Store 생성 후)
      - key: MONGODB_URI
        sync: false  # 수동 설정 필요 (MongoDB Atlas)
      - key: MONGODB_DB
        value: mediassist
      - key: OPENAI_API_KEY
        sync: false  # 수동 설정 필요
      - key: GOOGLE_API_KEY
        sync: false  # Google Gemini API (선택)
      - key: JWT_SECRET
        generateValue: true  # 자동 생성
      - key: JWT_ALGORITHM
        value: HS256
      - key: CHROMA_HOST
        sync: false  # ChromaDB 호스트 (외부 서비스 또는 비활성화)
      - key: CHROMA_PORT
        value: "8000"
      - key: NEO4J_URI
        sync: false  # Neo4j Aura URI (선택)
      - key: NEO4J_USER
        value: neo4j
      - key: NEO4J_PASSWORD
        sync: false
      - key: MINIO_ENDPOINT
        sync: false  # S3 호환 스토리지 (선택)
      - key: MINIO_ACCESS_KEY
        sync: false
      - key: MINIO_SECRET_KEY
        sync: false
      - key: MINIO_BUCKET
        value: reports
      - key: CORS_ORIGINS_STR
        value: https://mediassist-frontend-4clk.onrender.com
      - key: DEBUG
        value: "false"
    autoDeploy: true

  # ============================================
  # Auth Service (MongoDB 기반 인증)
  # ============================================
  - type: web
    name: mediassist-auth
    runtime: docker
    dockerfilePath: ./services/auth/Dockerfile
    dockerContext: ./services/auth
    region: singapore
    plan: free
    healthCheckPath: /health
    envVars:
      - key: MONGODB_URI
        sync: false  # MongoDB Atlas URI
      - key: MONGODB_DB
        value: mediassist
      - key: JWT_SECRET
        fromService:
          name: mediassist-analysis
          type: web
          envVarKey: JWT_SECRET
      - key: JWT_ALGORITHM
        value: HS256
      - key: CORS_ORIGINS_STR
        value: https://mediassist-frontend-4clk.onrender.com
    autoDeploy: true

  # ============================================
  # Patient Service
  # ============================================
  - type: web
    name: mediassist-patient
    runtime: docker
    dockerfilePath: ./services/patient/Dockerfile
    dockerContext: ./services/patient
    region: singapore
    plan: free
    healthCheckPath: /health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mediassist-db
          property: connectionString
      - key: JWT_SECRET
        fromService:
          name: mediassist-analysis
          type: web
          envVarKey: JWT_SECRET
      - key: JWT_ALGORITHM
        value: HS256
      - key: CORS_ORIGINS_STR
        value: https://mediassist-frontend-4clk.onrender.com
    autoDeploy: true

  # ============================================
  # Report Service
  # ============================================
  - type: web
    name: mediassist-report
    runtime: docker
    dockerfilePath: ./services/report/Dockerfile
    dockerContext: ./services/report
    region: singapore
    plan: free
    healthCheckPath: /health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mediassist-db
          property: connectionString
      - key: JWT_SECRET
        fromService:
          name: mediassist-analysis
          type: web
          envVarKey: JWT_SECRET
      - key: JWT_ALGORITHM
        value: HS256
      - key: MINIO_ENDPOINT
        sync: false
      - key: MINIO_ACCESS_KEY
        sync: false
      - key: MINIO_SECRET_KEY
        sync: false
      - key: MINIO_BUCKET
        value: reports
      - key: CORS_ORIGINS_STR
        value: https://mediassist-frontend-4clk.onrender.com
    autoDeploy: true
